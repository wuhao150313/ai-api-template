# ç®€æ˜“æ ¡å›­æ™ºèƒ½åŠ©æ‰‹å¼€å‘æ•™ç¨‹

æœ¬æ•™ç¨‹å°†å¸¦ä½ ä»é›¶å¼€å§‹ï¼Œä½¿ç”¨ Spring AI Alibaba æ¡†æ¶æ„å»ºä¸€ä¸ªç®€æ˜“çš„æ ¡å›­æ™ºèƒ½åŠ©æ‰‹ã€‚è¿™ä¸ªåŠ©æ‰‹ä¸ä»…èƒ½å›ç­”å¤©æ°”é—®é¢˜ï¼Œè¿˜èƒ½æŸ¥è¯¢è¯¾ç¨‹ä¿¡æ¯ã€å›¾ä¹¦é¦†åº§ä½ï¼Œæˆä¸ºåŒå­¦ä»¬çš„è´´å¿ƒæ ¡å›­ç®¡å®¶ã€‚  
## ç¬¬ä¸€æ­¥ï¼šé¡¹ç›®åˆå§‹åŒ–  

### 1.1 ç¯å¢ƒå‡†å¤‡  

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿ä½ çš„å¼€å‘ç¯å¢ƒæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š  

```
# æ£€æŸ¥JDKç‰ˆæœ¬ï¼ˆéœ€è¦17æˆ–æ›´é«˜ï¼‰
java -version

# æ£€æŸ¥Mavenç‰ˆæœ¬ï¼ˆéœ€è¦3.8æˆ–æ›´é«˜ï¼‰
mvn -version
```

å¦‚æœæœªå®‰è£…æˆ–ç‰ˆæœ¬è¿‡ä½ï¼Œè¯·å‰å¾€ä»¥ä¸‹åœ°å€ä¸‹è½½ï¼š  
â—JDK: [https://bell-sw.com/pages/downloads/](https://bell-sw.com/pages/downloads/)  
â—Maven: [https://maven.apache.org/download.cgi](https://maven.apache.org/download.cgi)  
### 1.2 åˆ›å»º Spring Boot é¡¹ç›®  

åˆ›å»º Spring Boot é¡¹ç›® campus-assistantã€‚  

![image.png](https://cdn.nlark.com/yuque/0/2025/png/228333/1764130901447-2b83b5c3-b42a-4f44-8a7e-51ffd5f94f1a.png)

## ç¬¬äºŒæ­¥ï¼šæ·»åŠ é¡¹ç›®ä¾èµ–  

ç¼–è¾‘ pom.xml æ–‡ä»¶ï¼Œæ›¿æ¢ä¸ºä»¥ä¸‹å†…å®¹ï¼š  

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.7</version>
        <relativePath/>
    </parent>

    <groupId>top.mqxu</groupId>
    <artifactId>campus-assistant</artifactId>
    <version>1.0-SNAPSHOT</version>
    <packaging>jar</packaging>
    <name>campus-assistant</name>
    <description>æ ¡å›­åŠ©æ‰‹</description>

    <properties>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <spring-ai-alibaba.version>1.1.0.0-M5</spring-ai-alibaba.version>
    </properties>

    <dependencies>
        <!-- Spring Boot Web Starter -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- Spring AI Alibaba Agent Framework -->
        <dependency>
            <groupId>com.alibaba.cloud.ai</groupId>
            <artifactId>spring-ai-alibaba-agent-framework</artifactId>
            <version>${spring-ai-alibaba.version}</version>
        </dependency>

        <!-- DashScope ChatModel æ”¯æŒ -->
        <dependency>
            <groupId>com.alibaba.cloud.ai</groupId>
            <artifactId>spring-ai-alibaba-starter-dashscope</artifactId>
            <version>${spring-ai-alibaba.version}</version>
        </dependency>

        <!-- Lombokï¼ˆå¯é€‰ï¼Œç®€åŒ–ä»£ç ï¼‰ -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

ä¸‹è½½ä¾èµ–ï¼š  

```

mvnÂ cleanÂ install  

```

## ç¬¬ä¸‰æ­¥ï¼šé…ç½®APIå¯†é’¥  

### 3.1 è·å– DashScope API Key  

1è®¿é—®é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°ï¼š[https://bailian.console.aliyun.com](https://bailian.console.aliyun.com)  
2æ³¨å†Œ/ç™»å½•è´¦å·  
3è¿›å…¥"API-KEY"é¡µé¢ï¼Œç‚¹å‡»"åˆ›å»ºæ–°çš„ API-KEY"  
4å¤åˆ¶ç”Ÿæˆçš„ API Key  
### 3.2 é…ç½®ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰  

é¡¹ç›®ç›®å½•ä¸‹ï¼Œæ‰§è¡Œå‘½ä»¤ï¼ˆLinux/macOSï¼‰ï¼Œåªå¯¹å½“å‰é¡¹ç›®æœ‰æ•ˆã€‚  

```
export AI_DASHSCOPE_API_KEY=ä½ çš„api_key_here
```

Windows ç”¨æˆ·æ‰§è¡Œå‘½ä»¤ï¼š  

```
set AI_DASHSCOPE_API_KEY=ä½ çš„api_key_here
```

### 3.3 åˆ›å»ºåº”ç”¨é…ç½®æ–‡ä»¶  

æŠŠsrc/main/resources/ ç›®å½•ä¸‹çš„ application.properties æ”¹ä¸º application.ymlï¼š  

```
server:
  port: 8080

spring:
  ai:
    dashscope:
      api-key: ${AI_DASHSCOPE_API_KEY}
      chat:
        options:
          model: qwen-max
          temperature: 0.7
          max-tokens: 2000
```

## ç¬¬å››æ­¥ï¼šåˆ›å»ºç¬¬ä¸€ä¸ªç®€å•çš„æ ¡å›­é—®ç­” Agent  

æˆ‘ä»¬å…ˆä»ä¸€ä¸ªèƒ½å›ç­”ç®€å•æ ¡å›­é—®é¢˜çš„ Agent å¼€å§‹ã€‚  
### 4.1 åˆ›å»ºæ ¡å›­ä¿¡æ¯å·¥å…·ç±»  

åˆ›å»º tool å­åŒ…ï¼Œåˆ›å»ºæ ¡å›­ä¿¡æ¯å·¥å…·ç±» CampusInfoTool.javaï¼š  

```
package top.mqxu.assistant.tool;

import org.springframework.ai.chat.model.ToolContext;
import org.springframework.ai.tool.annotation.ToolParam;
import org.springframework.stereotype.Component;

import java.util.function.BiFunction;

/**
 * @author mqxu
 * @date 2025/11/26
 * @description æ ¡å›­ä¿¡æ¯å·¥å…·ç±»
 * BiFunction çš„ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ª String ä»£è¡¨å…¥å‚ä¸ºå­—ç¬¦ä¸²ï¼Œä¸­é—´æ˜¯ä¸Šä¸‹æ–‡ï¼Œæœ€åçš„ String è¡¨ç¤ºè¿”å›ä¿¡æ¯æ˜¯å­—ç¬¦ä¸²
 **/
@Component
public class CampusInfoTool implements BiFunction<String, ToolContext, String> {

    @Override
    public String apply(
            @ToolParam(description = "å­¦ç”Ÿçš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šå›¾ä¹¦é¦†å¼€æ”¾æ—¶é—´ã€é£Ÿå ‚ä½ç½®ç­‰") String query,
            ToolContext toolContext) {

        // æ¨¡æ‹Ÿæ ¡å›­çŸ¥è¯†åº“
        if (query.contains("å›¾ä¹¦é¦†")) {
            return "å›¾ä¹¦é¦†åœ¨æ•™å­¦æ¥¼Aåº§æ—è¾¹ï¼Œå¼€æ”¾æ—¶é—´æ˜¯8:00-22:00ï¼Œå‘¨å…­æ—¥æ­£å¸¸å¼€æ”¾ã€‚";
        } else if (query.contains("é£Ÿå ‚")) {
            return "å­¦æ ¡æœ‰ä¸‰ä¸ªé£Ÿå ‚ï¼šç¬¬ä¸€é£Ÿå ‚åœ¨å®¿èˆåŒºï¼ˆ6:30-21:30ï¼‰ï¼Œç¬¬äºŒé£Ÿå ‚åœ¨ä½“è‚²é¦†æ—ï¼ˆ7:00-21:00ï¼‰ï¼Œç¬¬ä¸‰é£Ÿå ‚æ˜¯æ¸…çœŸé£Ÿå ‚ï¼ˆ7:00-20:30ï¼‰ã€‚";
        } else if (query.contains("æ•™åŠ¡å¤„")) {
            return "æ•™åŠ¡å¤„ä½äºè¡Œæ”¿æ¥¼3æ¥¼ï¼Œç”µè¯ï¼š010-12345678ã€‚";
        } else {
            return "æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚ä½ å¯ä»¥å’¨è¯¢å­¦æ ¡å®˜æ–¹å…¬ä¼—å·æˆ–æ‹¨æ‰“æ ¡å›­çƒ­çº¿010-12345678ã€‚";
        }
    }
}
```

### 4.2 åˆ›å»ºåŸºç¡€ Agent é…ç½®  

åˆ›å»ºconfig å­åŒ…ï¼Œåˆ›å»º Agent é…ç½®ç±»AgentConfig.javaï¼š  

```
package top.mqxu.assistant.config;

import com.alibaba.cloud.ai.dashscope.api.DashScopeApi;
import com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;
import com.alibaba.cloud.ai.graph.agent.ReactAgent;
import com.alibaba.cloud.ai.graph.checkpoint.savers.MemorySaver;
import org.springframework.ai.tool.ToolCallback;
import org.springframework.ai.tool.function.FunctionToolCallback;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import top.mqxu.assistant.tool.CampusInfoTool;

/**
 * @author mqxu
 * @date 2025/11/26
 * @description Agent é…ç½®ç±»
 **/
@Configuration
public class AgentConfig {

    @Value("${spring.ai.dashscope.api-key}")
    private String apiKey;

    @Bean
    public DashScopeApi dashScopeApi() {
        return DashScopeApi.builder()
                .apiKey(apiKey)
                .build();
    }

    @Bean
    public DashScopeChatModel chatModel(DashScopeApi dashScopeApi) {
        return DashScopeChatModel.builder()
                .dashScopeApi(dashScopeApi)
                .build();
    }

    @Bean
    public ToolCallback campusInfoToolCallback(CampusInfoTool campusInfoTool) {
        return FunctionToolCallback
                .builder("getCampusInfo", campusInfoTool)
                .description("æŸ¥è¯¢æ ¡å›­ç›¸å…³ä¿¡æ¯ï¼Œå¦‚å›¾ä¹¦é¦†ã€é£Ÿå ‚ã€æ•™åŠ¡å¤„ç­‰")
                .inputType(String.class)
                .build();
    }


    @Bean
    public ReactAgent reactAgent(DashScopeChatModel chatModel, ToolCallback campusInfoToolCallback) {
        return ReactAgent.builder()
                .name("campus_assistant")
                .model(chatModel)
                .systemPrompt("ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„æ ¡å›­åŠ©æ‰‹ï¼Œè´Ÿè´£å›ç­”å­¦ç”Ÿå…³äºæ ¡å›­ç”Ÿæ´»çš„å„ç§é—®é¢˜ã€‚å›ç­”è¦ç®€æ´æ˜äº†ï¼Œè¯­æ°”äº²åˆ‡ã€‚")
                .tools(campusInfoToolCallback)
                .saver(new MemorySaver())
                .build();
    }
}
```

### 4.3 åˆ›å»ºæµ‹è¯•æ¥å£  

åˆ›å»º controller å­åŒ…ï¼Œåˆ›å»ºæµ‹è¯•æ¥å£SimpleAgentController.javaï¼š  

```
package top.mqxu.assistant.controller;

import com.alibaba.cloud.ai.graph.agent.ReactAgent;
import com.alibaba.cloud.ai.graph.exception.GraphRunnerException;
import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.messages.AssistantMessage;
import org.springframework.web.bind.annotation.*;

/**
 * @author mqxu
 * @date 2025/11/26
 * @description æµ‹è¯• Controller
 **/
@RestController
@RequestMapping("/api/v1")
@CrossOrigin(origins = "*")
@RequiredArgsConstructor
public class SimpleAgentController {

    private final ReactAgent reactAgent;

    @GetMapping("/chat")
    public String chat(@RequestParam(value = "question", defaultValue = "å›¾ä¹¦é¦†åœ¨å“ªé‡Œ") String question) {
        AssistantMessage response;
        try {
            response = reactAgent.call(question);
        } catch (GraphRunnerException e) {
            throw new RuntimeException(e);
        }
        return response.getText();
    }
}
```

### 4.4 è¿è¡Œå¹¶æµ‹è¯•  

å¯åŠ¨åº”ç”¨ï¼š  

```

mvnÂ spring-boot:run  

```

æµ‹è¯• APIï¼š[http://127.0.0.1:8080/api/v1/chat](http://127.0.0.1:8080/api/v1/chat)  

![image.png](https://cdn.nlark.com/yuque/0/2025/png/228333/1764134745220-aded74c0-e951-4eaf-9492-326d050df59a.png)

![image.png](https://cdn.nlark.com/yuque/0/2025/png/228333/1764134783743-cb6c5b91-332e-4d71-8eec-4f655c70e40e.png)

## ç¬¬äº”æ­¥ï¼šæ„å»ºå®Œæ•´çš„æ ¡å›­æ™ºèƒ½åŠ©æ‰‹  

ç°åœ¨æˆ‘ä»¬æ¥æ„å»ºæ›´å¼ºå¤§çš„åŠ©æ‰‹ï¼Œæ•´åˆå¤šä¸ªåŠŸèƒ½ã€‚  
### 5.1 æ‰©å±•å·¥å…·é›†  

åœ¨ tool åŒ…ä¸‹æ·»åŠ æ›´å¤šå®ç”¨å·¥å…·ï¼š  
a) å¤©æ°”æŸ¥è¯¢å·¥å…· WeatherTool.javaï¼š  

```
package top.mqxu.assistant.tool;

import org.springframework.ai.chat.model.ToolContext;
import org.springframework.ai.tool.annotation.ToolParam;
import org.springframework.stereotype.Component;

import java.util.function.BiFunction;

/**
 * @author mqxu
 * @date 2025/11/26
 * @description å¤©æ°”æŸ¥è¯¢å·¥å…·
 **/
@Component
public class WeatherTool implements BiFunction<String, ToolContext, String> {

    @Override
    public String apply(
            @ToolParam(description = "åŸå¸‚åç§°ï¼Œå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€å—äº¬") String city,
            ToolContext toolContext) {
        // å®é™…é¡¹ç›®ä¸­è¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„å¤©æ°”API
        // è¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        return String.format("{ \"city\": \"%s\", \"weather\": \"æ™´å¤©\", \"temperature\": \"22Â°C\", \"advice\": \"é€‚åˆå‡ºè¡Œï¼Œå»ºè®®ç©¿é•¿è¢–\" }", city);
    }
}
```

b) è¯¾ç¨‹æŸ¥è¯¢å·¥å…· CourseQueryTool.javaï¼š  

```
package top.mqxu.assistant.tool;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.ai.chat.model.ToolContext;
import org.springframework.ai.tool.annotation.ToolParam;
import org.springframework.stereotype.Component;

import java.util.Arrays;
import java.util.List;
import java.util.function.BiFunction;

/**
 * @author mqxu
 * @date 2025/11/26
 * @description è¯¾ç¨‹æŸ¥è¯¢å·¥å…·
 **/
@Component
public class CourseQueryTool implements BiFunction<String, ToolContext, List<CourseQueryTool.Course>> {

    @Override
    public List<Course> apply(
            @ToolParam(description = "å­¦ç”Ÿå­¦å·") String studentId,
            ToolContext toolContext) {
        //ç»æµ‹è¯•ï¼Œå‰ç«¯ç»™äº†å­¦å·åï¼Œä¼ åˆ°è¿™é‡Œå˜æˆäº† {"studentId":"20220001"}ï¼Œæ‰€ä»¥å°±ç®€å•å¤„ç†äº†ä¸€ä¸‹
        if (studentId.contains("20220001")) {
            return Arrays.asList(
                    new Course("Spring Boot", "08:00-09:40", "æ•™å››319"),
                    new Course("Spring AI", "13:30-15:10", "æ•™å››419"));
        }
        if (studentId.contains("20220002")) {
            return Arrays.asList(
                    new Course("Spring Boot", "08:00-09:40", "æ•™å››319"),
                    new Course("Spring AI", "13:30-15:10", "æ•™å››419"));
        }
        return List.of();
    }

    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    public static class Course {
        private String name;
        private String time;
        private String location;
    }
}
```

c) å›¾ä¹¦é¦†åº§ä½æŸ¥è¯¢å·¥å…· LibrarySeatTool.javaï¼š  

```
package top.mqxu.assistant.tool;

import org.springframework.ai.chat.model.ToolContext;
import org.springframework.ai.tool.annotation.ToolParam;
import org.springframework.stereotype.Component;

import java.util.Random;
import java.util.function.BiFunction;

/**
 * @author mqxu
 * @date 2025/11/26
 * @description å›¾ä¹¦é¦†åº§ä½æŸ¥è¯¢å·¥å…·
 **/
@Component
public class LibrarySeatTool implements BiFunction<String, ToolContext, String> {

    @Override
    public String apply(
            @ToolParam(description = "å›¾ä¹¦é¦†åŒºåŸŸï¼Œå¦‚ï¼šAåŒºã€BåŒºã€CåŒº") String area,
            ToolContext toolContext) {

        Random random = new Random();
        int totalSeats = 200;
        // 20-170 ä¹‹é—´çš„éšæœºæ•°
        int occupied = random.nextInt(150) + 20;
        int available = totalSeats - occupied;

        return String.format("{ \"area\": \"%s\", \"totalSeats\": %d, \"occupied\": %d, \"available\": %d, \"availabilityRate\": \"%.1f%%\" }",
                area, totalSeats, occupied, available, (available * 100.0 / totalSeats));
    }
}
```

### 5.2 åˆ›å»ºç»“æ„åŒ–è¾“å‡ºç±»  

æ–°å»ºmodel å­åŒ…ï¼Œåˆ›å»ºç»“æ„åŒ–è¾“å‡ºç±»AssistantResponse.javaï¼š  

```
package top.mqxu.assistant.model;

import lombok.Data;

/**
 * @author mqxu
 * @date 2025/11/26
 * @description ç»“æ„åŒ–è¾“å‡ºç±»
 **/
@Data
public class AssistantResponse {
    // ç”¨æˆ·id
    private String userId;
    // çº¿ç¨‹id
    private String threadId;
    // ä¸»è¦å›ç­”å†…å®¹
    private String answer;
    // ç›¸å…³å»ºè®®
    private String suggestion;
    // å›ç­”ç±»å‹ï¼šweather/course/library/general
    private String type;
    // æ˜¯å¦éœ€è¦è¿›ä¸€æ­¥å¸®åŠ©
    private boolean needsFurtherHelp;
}
```

### 5.3 å®Œæ•´çš„ Agent é…ç½®  

ä¿®æ”¹ AgentConfig.javaï¼Œè¡¥å……æ›´å¤šé…ç½®ã€‚  

```
package top.mqxu.assistant.config;

import com.alibaba.cloud.ai.dashscope.api.DashScopeApi;
import com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;
import com.alibaba.cloud.ai.dashscope.chat.DashScopeChatOptions;
import com.alibaba.cloud.ai.graph.agent.ReactAgent;
import com.alibaba.cloud.ai.graph.checkpoint.savers.MemorySaver;
import org.springframework.ai.tool.ToolCallback;
import org.springframework.ai.tool.function.FunctionToolCallback;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import top.mqxu.assistant.tool.CampusInfoTool;
import top.mqxu.assistant.tool.CourseQueryTool;
import top.mqxu.assistant.tool.LibrarySeatTool;
import top.mqxu.assistant.tool.WeatherTool;

/**
 * @author mqxu
 * @date 2025/11/26
 * @description Agent é…ç½®ç±»
 **/
@Configuration
public class AgentConfig {

    @Value("${spring.ai.dashscope.api-key}")
    private String apiKey;

    private static final String SYSTEM_PROMPT = """
            ä½ æ˜¯ä¸€ä¸ªè´´å¿ƒçš„æ ¡å›­æ™ºèƒ½åŠ©æ‰‹"å°æ¤°"ï¼Œä¸“é—¨æœåŠ¡å¤§å­¦ç”Ÿç¾¤ä½“ã€‚
            
            ä½ çš„èŒè´£åŒ…æ‹¬ï¼š
            1. æŸ¥è¯¢å¤©æ°”ä¿¡æ¯ï¼Œå¸®åŠ©å­¦ç”Ÿå†³å®šç©¿è¡£å’Œå‡ºè¡Œ
            2. æŸ¥è¯¢è¯¾ç¨‹è¡¨ï¼Œæé†’å­¦ç”Ÿä¸Šè¯¾æ—¶é—´åœ°ç‚¹
            3. æŸ¥è¯¢å›¾ä¹¦é¦†åº§ä½æƒ…å†µï¼Œå¸®åŠ©å­¦ç”Ÿæ‰¾åˆ°è‡ªä¹ ä½ç½®
            4. å›ç­”å„ç±»æ ¡å›­ç”Ÿæ´»é—®é¢˜
            
            è¡Œä¸ºå‡†åˆ™ï¼š
            - ä½¿ç”¨è½»æ¾å‹å¥½çš„è¯­æ°”ï¼Œåƒå­¦é•¿å­¦å§ä¸€æ ·äº²åˆ‡
            - å›ç­”è¦å…·ä½“å®ç”¨ï¼Œä¸è¦ç©ºæ³›
            - ä¸»åŠ¨æä¾›ç›¸å…³å»ºè®®
            - ä¸ç¡®å®šçš„ä¿¡æ¯è¦è¯´æ˜æ¸…æ¥š
            - é€‚å½“ä½¿ç”¨ emoji è®©å¯¹è¯æ›´ç”ŸåŠ¨
            
            å·¥å…·ä½¿ç”¨è§„åˆ™ï¼š
            - æŸ¥è¯¢å¤©æ°”ï¼šå½“å­¦ç”Ÿæåˆ°å¤©æ°”ã€æ¸©åº¦ã€ç©¿è¡£å»ºè®®æ—¶ä½¿ç”¨ getWeather å·¥å…·
            - æŸ¥è¯¢è¯¾ç¨‹ï¼šå½“å­¦ç”Ÿé—®è¯¾ç¨‹ã€è¯¾è¡¨ã€ä¸Šè¯¾åœ°ç‚¹æ—¶ä½¿ç”¨ getCourseInfo å·¥å…·ï¼ˆéœ€è¦å­¦å·ï¼‰
            - æŸ¥è¯¢å›¾ä¹¦é¦†ï¼šå½“å­¦ç”Ÿé—®å›¾ä¹¦é¦†ã€è‡ªä¹ ã€åº§ä½æ—¶ä½¿ç”¨ getLibrarySeat å·¥å…·
            - æ ¡å›­ä¿¡æ¯ï¼šå…¶ä»–æ ¡å›­ç›¸å…³é—®é¢˜ä½¿ç”¨ getCampusInfo å·¥å…·
            """;

    @Bean
    public DashScopeApi dashScopeApi() {
        return DashScopeApi.builder()
                .apiKey(apiKey)
                .build();
    }


    @Bean
    public DashScopeChatModel chatModel(DashScopeApi dashScopeApi) {
        return DashScopeChatModel.builder()
                .dashScopeApi(dashScopeApi)
                .build();
    }


    @Bean
    public ToolCallback campusInfoToolCallback(CampusInfoTool campusInfoTool) {
        return FunctionToolCallback
                .builder("getCampusInfo", campusInfoTool)
                .description("æŸ¥è¯¢æ ¡å›­ç›¸å…³ä¿¡æ¯ï¼Œå¦‚å›¾ä¹¦é¦†ã€é£Ÿå ‚ã€æ•™åŠ¡å¤„ç­‰")
                .inputType(String.class)
                .build();
    }

    @Bean
    public ToolCallback weatherToolToolCallback(WeatherTool weatherTool) {
        return FunctionToolCallback
                .builder("getWeather", weatherTool)
                .description("æŸ¥è¯¢å¤©æ°”ä¿¡æ¯ï¼Œå¦‚æ¸©åº¦ã€å¤©æ°”æƒ…å†µã€ç©¿è¡£å»ºè®®")
                .inputType(String.class)
                .build();
    }

    @Bean
    public ToolCallback courseQueryToolCallback(CourseQueryTool courseQueryTool) {
        return FunctionToolCallback
                .builder("getCourseInfo", courseQueryTool)
                .description("æŸ¥è¯¢è¯¾ç¨‹ä¿¡æ¯ï¼Œå¦‚è¯¾ç¨‹åç§°ã€æ—¶é—´ã€åœ°ç‚¹")
                .inputType(String.class)
                .build();
    }

    @Bean
    public ToolCallback librarySeatToolCallback(LibrarySeatTool librarySeatTool) {
        return FunctionToolCallback
                .builder("getLibrarySeat", librarySeatTool)
                .description("æŸ¥è¯¢å›¾ä¹¦é¦†åº§ä½æƒ…å†µï¼Œå¦‚ç©ºé—²åº§ä½æ•°ã€ä½ç½®ç­‰")
                .inputType(String.class)
                .build();
    }

    @Bean
    public ReactAgent reactAgent(DashScopeChatModel chatModel,
                                 ToolCallback campusInfoToolCallback,
                                 ToolCallback weatherToolToolCallback,
                                 ToolCallback courseQueryToolCallback,
                                 ToolCallback librarySeatToolCallback) {
        return ReactAgent.builder()
                .name("campus_assistant")
                .model(chatModel)
                .systemPrompt(SYSTEM_PROMPT)
                .tools(campusInfoToolCallback, weatherToolToolCallback, courseQueryToolCallback, librarySeatToolCallback)
                .saver(new MemorySaver())
                .build();
    }
}
```

### 5.4 åˆ›å»ºå¸¦è®°å¿†åŠŸèƒ½çš„ Controller  

åœ¨ controller åŒ…ä¸‹åˆ›å»º AdvancedAgentController.javaï¼š  

```
package top.mqxu.assistant.controller;

import com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;
import com.alibaba.cloud.ai.graph.RunnableConfig;
import com.alibaba.cloud.ai.graph.agent.ReactAgent;
import com.alibaba.cloud.ai.graph.checkpoint.savers.MemorySaver;
import com.alibaba.cloud.ai.graph.exception.GraphRunnerException;
import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.messages.AssistantMessage;
import org.springframework.web.bind.annotation.*;
import top.mqxu.assistant.model.AssistantResponse;
import top.mqxu.assistant.model.RequestDTO;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * @author mqxu
 * @date 2025/11/26
 * @description å¸¦è®°å¿†åŠŸèƒ½çš„ Controller
 **/
@RestController
@RequestMapping("/api/v2")
@RequiredArgsConstructor
@CrossOrigin(origins = "*")
public class AdvancedAgentController {

    private final ReactAgent reactAgent;
    private final DashScopeChatModel chatModel;

    // å­˜å‚¨ç”¨æˆ·çš„ threadId æ˜ å°„
    private final Map<String, String> userThreadMap = new HashMap<>();


    @PostMapping("/chat")
    public AssistantResponse chat(@RequestBody RequestDTO request) {
        String userId = request.getUserId();
        String message = request.getMessage();
        // ä¸ºæ¯ä¸ªç”¨æˆ·ç”Ÿæˆæˆ–è·å– threadId
        String threadId = userThreadMap.computeIfAbsent(userId, k -> UUID.randomUUID().toString());
        // åˆ›å»ºé…ç½®
        RunnableConfig config = RunnableConfig.builder()
                .threadId(threadId)
                .addMetadata("user_id", userId)
                .build();
        // è°ƒç”¨ Agentï¼Œå¾—åˆ° AssistantMessage
        AssistantMessage response;
        try {
            response = reactAgent.call(message, config);
        } catch (GraphRunnerException e) {
            throw new RuntimeException(e);
        }
        // æ„å»ºè¿”å›ç»“æœ,å®é™…è¿”å›ç»“æœåº”è¯¥è¿›è¡Œå®šåˆ¶ï¼Œæ¯”å¦‚å›ç­”ç±»å‹ã€å»ºè®®ç­‰
        AssistantResponse assistantResponse = new AssistantResponse();
        assistantResponse.setAnswer(response.getText());
        assistantResponse.setType("general");
        assistantResponse.setSuggestion("è¯·æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œç»™å‡ºä¸€ä¸ªå»ºè®®");
        assistantResponse.setNeedsFurtherHelp(false);
        return assistantResponse;
    }

    @GetMapping("/history/{userId}")
    public Map<String, Object> getHistory(@PathVariable String userId) {
        String threadId = userThreadMap.get(userId);
        if (threadId == null) {
            return Map.of("error", "æœªæ‰¾åˆ°è¯¥ç”¨æˆ·çš„å†å²è®°å½•");
        }
        // ä»MemorySaverä¸­è·å–å†å²
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥å®ç°å®Œæ•´çš„historyæ¥å£
        return Map.of("userId", userId, "threadId", threadId, "history", "å†å²è®°å½•åŠŸèƒ½éœ€è¦è¿›ä¸€æ­¥å®ç°");
    }
}
```

## ç¬¬å…­æ­¥ï¼šè¿è¡Œæµ‹è¯•  

### 6.1 å¯åŠ¨åº”ç”¨  

```

mvnÂ spring-boot:run  

```

### 6.2 æµ‹è¯•å¤šåŠŸèƒ½åœºæ™¯  

åœºæ™¯1ï¼šæŸ¥è¯¢å¤©æ°”å¹¶è·å–ç©¿è¡£å»ºè®®  

```

curlÂ -XÂ POSTÂ http://localhost:8080/api/v2/chatÂ   
Â Â -HÂ "Content-Type: application/json"Â   
Â Â -dÂ '{"userId":"student001","message":"ä»Šå¤©å—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿæˆ‘è¯¥ç©¿ä»€ä¹ˆè¡£æœå»ä¸Šè¯¾ï¼Ÿ"}'  

```

![image.png](https://cdn.nlark.com/yuque/0/2025/png/228333/1764141101625-ca932fa5-507d-4e02-81bc-0724a0f5f2b9.png)

åœºæ™¯2ï¼šæŸ¥è¯¢ä»Šæ—¥è¯¾ç¨‹  

```

curlÂ -XÂ POSTÂ http://localhost:8080/api/v2/chatÂ   
Â Â -HÂ "Content-Type: application/json"Â   
Â Â -dÂ '{"userId":"student001","message":"æˆ‘çš„å­¦å·æ˜¯ 20220001ï¼Œä»Šå¤©æœ‰ä»€ä¹ˆè¯¾ï¼Ÿ"}'  

```

![image.png](https://cdn.nlark.com/yuque/0/2025/png/228333/1764141122430-57eef900-b145-4bc5-81e4-5d5b9e77c8ac.png)

åœºæ™¯3ï¼šæŸ¥è¯¢å›¾ä¹¦é¦†åº§ä½  

```

curlÂ -XÂ POSTÂ http://localhost:8080/api/v2/chatÂ   
Â Â -HÂ "Content-Type: application/json"Â   
Â Â -dÂ '{"userId":"student002","message":"å›¾ä¹¦é¦†AåŒºè¿˜æœ‰å¤šå°‘ç©ºåº§ä½ï¼Ÿ"}'  

```

![image.png](https://cdn.nlark.com/yuque/0/2025/png/228333/1764141142745-c5f55ef4-db0e-4865-afb6-e063ac0cdd3c.png)

åœºæ™¯4ï¼šå¤šè½®å¯¹è¯æµ‹è¯•  

```

# ç¬¬ä¸€è½®ï¼šè¯¢é—®å¤©æ°”  
curlÂ -XÂ POSTÂ http://localhost:8080/api/v2/chatÂ   
Â Â -HÂ "Content-Type: application/json"Â   
Â Â -dÂ '{"userId":"student003","message":"ä»Šå¤©å—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"}'  

# ç¬¬äºŒè½®ï¼šç»§ç»­è¯¢é—®  
# æ­¤æ—¶ Agent åº”è¯¥è®°å¾—ä¸Šä¸‹æ–‡,è¿”å›çš„ threadId ä¹Ÿæ˜¯ä¸€æ ·çš„  
curlÂ -XÂ POSTÂ http://localhost:8080/api/v2/chatÂ   
Â Â -HÂ "Content-Type: application/json"Â   
Â Â -dÂ '{"userId":"student003","message":"é‚£æ˜å¤©å‘¢ï¼Ÿ"}'  

```

![image.png](https://cdn.nlark.com/yuque/0/2025/png/228333/1764141168628-166b6685-5b69-4912-805f-26a1546c52d7.png)

æŸ¥è¯¢ç”¨æˆ·å†å²æ¶ˆæ¯ï¼š  

```

curl -X GET http://localhost:8080/api/v2/history/student003

```

![image.png](https://cdn.nlark.com/yuque/0/2025/png/228333/1764141210536-23aeab3f-fcb3-421f-9f0e-200b03871f1b.png?x-oss-process=image%2Fformat%2Cwebp)

## ç¬¬ä¸ƒæ­¥ï¼šå‰ç«¯é›†æˆç¤ºä¾‹  

åˆ›å»ºä¸€ä¸ªç®€å•çš„ HTML é¡µé¢æµ‹è¯• Agentï¼š  

```

<!DOCTYPE html>
<html lang="zh">
<head>
    <title>æ ¡å›­æ™ºèƒ½åŠ©æ‰‹</title>
    <meta charset="UTF-8"/>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
        }

        #chat {
            border: 1px solid #ccc;
            height: 500px;
            padding: 20px;
            overflow-y: scroll;
        }

        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }

        .user {
            background: #e3f2fd;
            text-align: right;
        }

        .bot {
            background: #f1f8e9;
        }

        #input {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<h1>ğŸ“ æ ¡å›­æ™ºèƒ½åŠ©æ‰‹ "å°æ¤°"</h1>
<div id="chat"></div>
<input id="input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ">

<script>
    const userId = 'user_' + Math.random().toString(36).substr(2, 9);
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');

    input.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter' && input.value.trim()) {
            const message = input.value.trim();
            addMessage(message, 'user');
            input.value = '';

            const response = await fetch('http://localhost:8080/api/v2/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({userId, message})
            });

            const data = await response.json();
            addMessage(data.answer, 'bot');
        }
    });

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.textContent = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }
</script>
</body>
</html>


```

å°†ä¸Šè¿°ä»£ç ä¿å­˜ä¸º chat.htmlï¼Œç”¨æµè§ˆå™¨æ‰“å¼€å³å¯ä¸æ ¡å›­åŠ©æ‰‹å¯¹è¯ã€‚  

![image.png](https://cdn.nlark.com/yuque/0/2025/png/228333/1764139955126-fe2318ae-bf05-412a-8f5d-e3d09935e67d.png?x-oss-process=image%2Fformat%2Cwebp)

## æ€»ç»“ä¸ä¸‹ä¸€æ­¥  

æ­å–œä½ ï¼ä½ å·²ç»æˆåŠŸæ„å»ºäº†ä¸€ä¸ªç®€æ˜“çš„æ ¡å›­æ™ºèƒ½åŠ©æ‰‹ï¼Œå…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š  
âœ… é¡¹ç›®åˆå§‹åŒ–ï¼šä» 0 åˆ° 1 åˆ›å»º Spring Boot é¡¹ç›® âœ… å¤šå·¥å…·é›†æˆï¼šå¤©æ°”ã€è¯¾ç¨‹ã€å›¾ä¹¦é¦†ã€æ ¡å›­ä¿¡æ¯æŸ¥è¯¢ âœ… å¯¹è¯è®°å¿†ï¼šæ”¯æŒå¤šè½®ä¸Šä¸‹æ–‡ç†è§£ âœ… ç»“æ„åŒ–è¾“å‡ºï¼šç»Ÿä¸€çš„å“åº”æ ¼å¼ âœ… API æ¥å£ï¼šæä¾› RESTful æœåŠ¡  
### ä¸‹ä¸€æ­¥å»ºè®®ï¼š  

1æ¥å…¥çœŸå® APIï¼šæ›¿æ¢æ¨¡æ‹Ÿæ•°æ®ï¼Œæ¥å…¥çœŸå®å¤©æ°” API ç­‰ï¼›  
2ç”¨æˆ·è®¤è¯ï¼šé›†æˆ Spring Securityï¼Œå®ç°å­¦ç”Ÿè´¦å·ç™»å½•ï¼›  
3å‰ç«¯ç¾åŒ–ï¼šå¼€å‘ Vue/é¸¿è’™ å‰ç«¯ï¼Œæ·»åŠ è¯­éŸ³è¾“å…¥åŠŸèƒ½ï¼›  
4æ€§èƒ½ä¼˜åŒ–ï¼šæ·»åŠ  Redis ç¼“å­˜å¸¸ç”¨æ•°æ®ï¼›  
5ç›‘æ§å‘Šè­¦ï¼šé›†æˆ Spring Boot Actuator ç›‘æ§ Agent è¿è¡ŒçŠ¶æ€ï¼›  
6å¤š Agent åä½œï¼šåˆ›å»ºä¸“é—¨å¤„ç†ä¸åŒä»»åŠ¡çš„å­ Agentï¼ˆå¦‚ä¸“é—¨å¤„ç†è¯¾ç¨‹é—®é¢˜çš„ CourseAgentï¼‰